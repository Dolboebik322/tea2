# CVE-2024-3566 (BatBadBut) - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CVE-2024-3566, —Ç–∞–∫–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞–∫ "BatBadBut".

## ‚ö†Ô∏è –í–ê–ñ–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï

**–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏–ª–∏ –¥–ª—è –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ü–µ–ª–µ–π!**

## –û–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

CVE-2024-3566 - —ç—Ç–æ —É—è–∑–≤–∏–º–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥–Ω–æ–π –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ Windows-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ—É–Ω–∫—Ü–∏—é `CreateProcess` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥. –ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞:

1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `.exe`
2. Windows –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
3. Windows –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç batch-—Ñ–∞–π–ª (.bat/.cmd) —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º
4. –ï—Å–ª–∏ —Ç–∞–∫–æ–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, Windows –≤—ã–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ `cmd.exe`
5. –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ batch-—Ñ–∞–π–ª –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## –§–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### üìã CVE-2024-3566-examples.md
–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —è–∑—ã–∫–∞—Ö:
- Node.js (child_process.spawn)
- PHP (proc_open)
- Rust (std::process::Command)
- Haskell (System.Process)

–í–∫–ª—é—á–∞–µ—Ç –º–µ—Ç–æ–¥—ã –∑–∞—â–∏—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

### üü® CVE-2024-3566-demo.js
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ Node.js, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∞—è:
- –£—è–∑–≤–∏–º—ã–π –∫–æ–¥
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

**–ó–∞–ø—É—Å–∫:**
```bash
node CVE-2024-3566-demo.js
```

### üêç CVE-2024-3566-python-demo.py
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ Python —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏:
- –£—è–∑–≤–∏–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è subprocess
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫
- –í–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π

**–ó–∞–ø—É—Å–∫:**
```bash
python CVE-2024-3566-python-demo.py
```

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ —è–∑—ã–∫–∏

- **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:** Windows (–≤—Å–µ –≤–µ—Ä—Å–∏–∏)
- **–Ø–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è:**
  - Node.js (–¥–æ –≤–µ—Ä—Å–∏–π 18.20.1, 20.12.1, 22.0.0)
  - Python (–≤—Å–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏)
  - PHP (–≤—Å–µ –≤–µ—Ä—Å–∏–∏)
  - Rust (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
  - Haskell (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ process)
  - Go (–ø–∞–∫–µ—Ç os/exec)

## –ú–µ—Ç–æ–¥—ã –∑–∞—â–∏—Ç—ã

### 1. –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è .exe
```javascript
// –í–º–µ—Å—Ç–æ:
spawn('git', ['clone', userInput])

// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
spawn('git.exe', ['clone', userInput])
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π
```javascript
const gitPath = 'C:\\Program Files\\Git\\bin\\git.exe';
spawn(gitPath, ['clone', userInput])
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```javascript
function validateInput(input) {
    const dangerousChars = /[&|;`$(){}[\]<>]/;
    if (dangerousChars.test(input)) {
        throw new Error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã');
    }
    return input;
}
```

### 4. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
```javascript
// Node.js - —Ä—É—á–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
function escapeShellArg(arg) {
    return '"' + arg.replace(/"/g, '""') + '"';
}

// Python - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ shlex
import shlex
escaped = shlex.quote(user_input)
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

- **Node.js:** 18.20.1+, 20.12.1+, 22.0.0+
- **–î—Ä—É–≥–∏–µ —è–∑—ã–∫–∏:** –¢—Ä–µ–±—É—é—Ç —Ä—É—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [CVE-2024-3566 –≤ NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-3566)
- [–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ Flatt Tech](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/)
- [CERT/CC Advisory](https://www.kb.cert.org/vuls/id/123335)

## –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –∫–æ–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö. –ê–≤—Ç–æ—Ä—ã –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —É—â–µ—Ä–±.
